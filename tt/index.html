<!DOCTYPE html>

<html>

<head>
	<script>
		/**

 * 

 * @authors Maggie

 * @date    2018-07-26 13:47:58

 * @params 

 *   index      当前选中对象的位置

 *   num        共有多少个对象参与抽奖

 *   speed      抽奖速度

 *   flag       响应点击事件

 *   lucky      中奖的位置

 *   award      奖品的名称

 *   times      转动次数

 *   timer      定时器

 *   cycle      转动基本次数，

 * @version 1.0.0

 */



;(function($){

	$.fn.lottery = function(opts){

		var defaults = {

			index: 0,

			num: 8,

			cycle: 50,

		}

		$.extend(defaults, opts);

		console.log(opts)



        var lottery,

            flag = false,

            timer = 0,

            times = 0;

		

        function show_lottery(){

			if (opts.index > opts.num) {

				opts.index = 1;

				opts.cycle--;

			}

			$('.lottery li').css('opacity', 0.3);

			$('.lottery'+opts.index).css('opacity', 1);

			console.log(opts.cycle, 'opts.cycle')

			



		    times += 1;

		    if( times < opts.cycle ){

		    	opts.speed -= 10;

		    }else{

		        if (times > opts.cycle + 10 && opts.lucky == opts.index + 1) {

		        	opts.speed += 110;

		        }else{

		        	opts.speed += 20;

		        }

		    }

		    if (opts.speed < 40) {

		    	opts.speed = 40;

		    }



			if (times > opts.cycle + 10 && opts.lucky == opts.index) {  //结束抽奖

				clearTimeout(timer);

				// 重置参数

				timer = 0;

				opts.speed = 300;

				opts.cycle = 50;

				times = 0;

				console.log('中奖位置', opts.lucky)

				// setTimeout(function(){

		  //           $('.lottery li').css('opacity', 1);

				// },1200)

				flag = false;

			}else{

				timer = setTimeout(show_lottery,opts.speed)

			}

			opts.index++;

		}



		return this.each(function() {

			console.log($(opts.draw))

			$(opts.draw).click(function(event) {

				if (flag) {

					return false;

				}

				flag = true;

				show_lottery();

			});

		});

		

	}

})(jQuery)
function rand(Min,Max){

    var Range = Max - Min;

    var Rand = Math.random();

    return(Min + Math.round(Rand * Range));

}

//定义参数

var index = 1,              //当前选中对象的位置

    fast,                   //在哪个位置开始加速

    num   = 8,              //共有多少个抽奖对象

    cycle,                  //转动多少圈

    speed = 300,            //开始时速度

    flag  = false,          //正在抽奖标志

    lucky,                  //中奖号码，实际应用由后台产生

    award,                  //奖品名称

    lottery;                //抽奖对象



//开始抽奖

function start_lottery(){

    if(flag){

        //alert('正在抽奖，请等待抽奖结果！');

        //return false;

        return void(0);

    }

    flag=true;

    index = 1;              //当前选中对象的位置

    fast  = rand(3,6);      //在哪个位置开始加速

    cycle = rand(3,5);      //转动多少圈

    speed = 300;            //开始时速度



    $.ajax({

        url: 'lottery.php',

        type: "post",

        data:null,

        dataType: "json",

        timeout: 20000,

        cache: false,

        beforeSend: function(){// 提交之前

        },

        error: function(){//出错

            flag=false;

        },

        success: function(res){//成功

            if(typeof(res.award_id)!='undefined'){

                lucky = res.award_id;    //中奖号码

                award = res.award_name;  //奖品名称

                show_lottery();

            }else{

                flag=false;

                alert(res.err);

            }

        }

    });

}

//抽奖效果展示

function show_lottery(){

    if(index>num){

        index = 1;

        cycle--;

    }

    $('#lottery li').css('opacity',0.3);

    $('#lottery_'+index).css('opacity',1);

    if(index>fast) speed=100;//开始加速

    if(cycle==0 && lucky-index<rand(2,5)) speed=speed+200;//开始减速

    if(cycle<=0 && index==lucky){//结束抽奖，选中号码

        clearTimeout(lottery);

        setTimeout(function(){

            $('#lottery li').css('opacity',1);

            alert('恭喜您获得：'+award);

        },1200);

        flag = false;

    }else{

        lottery = setTimeout(show_lottery,speed);

    }

    index++;

}


	/*抽奖lottery*/

	var lottery = {

		index: 0,    //当前转动到哪个位置，起点位置

		count: 0,    //总共有多少个位置

		timer: 0,    //setTimeout的ID，用clearTimeout清除

		speed: 20,    //初始转动速度

		times: 0,    //转动次数

		cycle: 50,    //转动基本次数：即至少需要转动多少次再进入抽奖环节

		prize: 0,    //中奖位置

		init: function (id) {

			if ($("#" + id).find(".lottery-unit").length > 0) {

				this.obj = $("#" + id);

				this.count = $("#" + id).find('.lottery-unit').length;

				$("#" + id).find(".lottery" + this.index).addClass("active" + this.index);

			};

		},

		roll: function () {

			var index = this.index;

			var count = this.count;

			var lottery = this.obj;

			$(lottery).find(".lottery" + index).removeClass("active" + index);

			index += 1;

			if (index > count) {

				index = 0;

			};

			$(lottery).find(".lottery" + index).addClass("active" + index);

			this.index = index;

			return false;

		},

		stop: function (index) {

			this.prize = index;

			return false;

		}

	};



	/*抽奖滚动事件*/

	function roll() {

		lottery.times += 1;

		lottery.roll();

		if (lottery.times > lottery.cycle + 10 && lottery.index == prize_site) {





			// alert('中奖位置')

			clearTimeout(lottery.timer);

			lottery.prize = -1;

			lottery.times = 0;

			click = false;



		} else {

			if (lottery.times < lottery.cycle) {

				lottery.speed -= 10;

			} else if (lottery.times == lottery.cycle) {

				var index = Math.random() * (lottery.count) | 0;

				lottery.prize = index;

			} else {

				if (lottery.times > lottery.cycle + 10 && ((lottery.prize == 0 && lottery.index == 7) || lottery.prize == lottery.index + 1)) {

					lottery.speed += 110;

				} else {

					lottery.speed += 20;

				}

			}

			if (lottery.speed < 40) {

				lottery.speed = 40;

			}

			lottery.timer = setTimeout(roll, lottery.speed);

		}

		return false;

	}



	/*抽奖过程中不响应点击事件*/

	var click = false;



	lottery.init('lottery');

	$('#lottery .btn_lottery').click(function (event) {

		if (getCookie('ab737') != '') {

			if (click) {

				return false;

			} else {

				lottery.speed = 100;

				$.ajax({

					url: 'lottery.php',

					type: 'get',

					dataType: 'json',

					success: function (res) {

						if (res.status == 0) {

							getUser();

						}

				 		if (res.status == 1) {

							prize_site = res.index; //中奖位置

							prize_name = res.name; //中奖名字

							prize_id = res.id; 

							lottery_id = res.id;

							cdkey = res.cdkey;





							lottery.prize = prize_site; //中奖记录



							$('#lottery').attr('prize_site', prize_site);

							$('#lottery').attr('prize_name', prize_name);

							$('#lottery').attr('prize_virtual', isVirtual);

							$('#lottery').attr('prize_img', prize_img);

							$('#lottery').attr('prize_id', prize_id)



							roll();    //转圈过程不响应click事件，会将click置为false

							click = true; //一次抽奖完成后，设置click为true，可继续抽奖

							return false;

						}

						if (res.status == -1) {

							alert(res.text)

						}

					}

				});

			}

		}else{

			getUser();

		}

	})
	</script>

<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

<title>Examples</title>

<meta name="description" content="">

<meta name="keywords" content="">

<link href="css/index.css" rel="stylesheet">

<style>
	

*{

	padding: 0;

	margin: 0;

}



body{

	width: 1200px;

	height: 100%;

	margin:  0 auto;

}



.lottery{

	width: 650px;

	height: 650px;

	border-radius: 50%;

	background: #eee;

	position: relative;

	margin: 0 auto;

	cursor: pointer;

}



.middle{

	position: absolute;

	top: 50%;

	left: 50%;

	-webkit-transform: translate(-50%,-50%);

	   -moz-transform: translate(-50%,-50%);

	    -ms-transform: translate(-50%,-50%);

	     -o-transform: translate(-50%,-50%);

	        transform: translate(-50%,-50%);

}



.lottery li{

	width: 150px;

	height: 150px;

	border-radius: 50%;

	list-style: none;

	display: inline-block;

	position: absolute;

}



.lottery1{

    top: 50px;

    left: 94px;

}



.lottery2{

	top: 20px;

	left: 250px;

}



.lottery3{

	top: 50px;

	left: 400px;

}



.lottery4{

	top: 250px;

	left: 480px;

}



.lottery5{

	top: 400px;

	left: 400px;

}



.lottery6{

	top: 450px;

	left: 250px;

}



.lottery7{

	top: 400px;

	left: 100px;

}



.lottery8{

	top: 250px;

	left: 40px;

}
</style>
</head>

<body>

	<ul class="lottery">

		<img class="middle" src="./images/middle.jpg" alt="">

		<li class="lottery-unit lottery1"><img src="./images/1.png" alt=""></li>

		<li class="lottery-unit lottery2"><img src="img/QQ图片20190911195424.jpg" alt=""></li>

		<li class="lottery-unit lottery3"><img src="img/QQ图片20190911195424.jpg" alt=""></li>

		<li class="lottery-unit lottery4"><img src="img/QQ图片20190911195424.jpg" alt=""></li>

		<li class="lottery-unit lottery5"><img src="./images/5.png" alt=""></li>

		<li class="lottery-unit lottery6"><img src="./images/6.png" alt=""></li>

		<li class="lottery-unit lottery7"><img src="./images/7.png" alt=""></li>

		<li class="lottery-unit lottery8"><img src="./images/8.png" alt=""></li>

	</ul> 
	<script src="./js/lottery.js" type="text/javascript"></script>

<script type="text/javascript">



    var award_id = Math.random() * (8) | 0;

    var award_name = 'thanks you'



	$('.lottery').lottery({

		index: 0,

		num: 8,

		cycle: 50,

		lucky: award_id,

		award: award_name,

		speed: 300,

		draw: '.middle'

	});

</script>

</body>



</html>